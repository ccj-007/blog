# 10åˆ†é’Ÿæé€Ÿæ­å»ºâ€”â€”å‰ç«¯è„šæ‰‹æ¶(å¤šæ¨¡æ¿)

# èƒŒæ™¯
ä½ æ˜¯å¦åœ¨å·¥ä½œä¸­æ‰¾ä¸ªæ¨¡æ¿ï¼Œè¦åå¤å»ä»£ç ä»“åº“å»æ‹‰å–ä»£ç ï¼Œä½†æ˜¯ç°åœ¨åªè¦ç®€å•å‡ åˆ†é’Ÿï¼Œå°±å¯ä»¥å¿«é€Ÿå®ç°åƒvue cliä¸€æ ·çš„åŠŸèƒ½ï¼Œåœ¨ç»ˆç«¯é€‰æ‹©å¯¹åº”çš„æ¨¡æ¿ï¼Œç”Ÿæˆå¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼ŒåŒæ—¶æ”¯æŒä»»æ„æ‹“å±•ä¸åŒçš„æ¨¡æ¿ã€‚å¯¹äºå…¬å¸çš„å‰ç«¯åŸºå»ºçš„å»ºè®¾è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„

![logo (3).png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d071c6e2e9148d3907bbb00de77e708~tplv-k3u1fbpfcp-watermark.image?)

githubæºç åœ°å€  https://github.com/ccj-007/web-core-cli è§‰å¾—ä¸é”™å¯ä»¥ç‚¹ä¸ªstar â­

# å¼€å§‹

é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“è„šæ‰‹æ¶éœ€è¦å¯¹åº”çš„å“ªäº›åŒ…ï¼Ÿ


| npm  |   description  |
| --- | ---   |
| chalk  | åœ¨ç»ˆç«¯çš„æ–‡æœ¬æ ·å¼ä¿®æ”¹ |
| commander  | å‘½ä»¤è¡Œäº¤äº’ç•Œé¢ |
| cross-spawn  | ç”¨äºæ‰§è¡Œnodeçš„å‘½ä»¤ |
| ejs  | æ¨¡æ¿æ¸²æŸ“å¯ä»¥æ›´åŠ ç»†åŒ–çš„é…åˆcommanderæ§åˆ¶ä»£ç é€»è¾‘ç”Ÿæˆ |
| figlet  | ç»ˆç«¯æ˜¾ç¤ºçš„logo |
| shelljs  | æ‰§è¡Œshellå‘½ä»¤ |
| ora  | è½¬åœˆåœˆ |
| inquirer  | è·Ÿç»ˆç«¯äº¤äº’ï¼Œé€‰æ‹©å¯¹åº”çš„æ¨¡æ¿ç±»å‹ |
| fs-extra  | å°è£…nodeçš„æ–‡ä»¶apiï¼Œæ›´å¼ºå¤§ |

äº†è§£äº†æˆ‘ä»¬çš„å·¥å…·åŒ…ï¼Œä¸‹é¢æˆ‘ä»¬çš„**æ€è·¯**æ˜¯è¾“å…¥æˆ‘ä»¬çš„åŒ…åï¼Œèƒ½æƒ³vueä¸€æ ·ç”Ÿæˆå¯¹åº”çš„äº¤äº’æ¨¡æ¿ ï¼Œå‘½ä»¤è¡Œè¾“å…¥ç±»ä¼¼ vue create my-appç”Ÿæˆå¯¹åº”çš„é¡¹ç›®åçš„æ–‡ä»¶ï¼Œç„¶åç”Ÿæˆå¤šä¸ªæ¨¡æ¿é€‰æ‹©ï¼ŒåŒæ—¶è€ƒè™‘æ–‡ä»¶å¤¹æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨é‚£ä¹ˆå°±è¦†ç›–ï¼ŒåŒæ—¶ä¹Ÿåƒvue-cliä¸€æ ·å¯ä»¥è·å–ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚å½“ç„¶ä¹Ÿéœ€è¦è€ƒè™‘åŠ ä¸€äº›logoã€chalkæ–‡æœ¬æ ·å¼æ•ˆæœï¼Œè¿˜æœ‰è¿›åº¦æ¡ã€‚ç„¶åæœ€åæŒ‰éœ€è¦å®‰è£…ä¾èµ–ï¼Œæœ€åç»™ä¸ªcd <æ–‡ä»¶å¤¹> npm run start çš„æç¤ºã€‚


### å¼€å¯ä¸€ä¸ªäº¤äº’ç•Œé¢


![QQæˆªå›¾20220717164953.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4eb99f6106964195af16abf69f13c585~tplv-k3u1fbpfcp-watermark.image?)

```js
#! /usr/bin/env node  //æ„æ€ç”¨nodeæ¥æ‰§è¡Œè¿™ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œ æ„å‘³ç€ä½ å¯ä»¥é€šè¿‡create <project> æ¥åˆ›å»ºæ–‡ä»¶
const program = require('commander')
const log = require('../lib/log')

//commanderé…ç½®nodeå‘½ä»¤äº¤äº’ç•Œé¢
program
  .on('--help', () => {
    log.outLOGO()
    log.outCyanLog(`Run  roc <command> --help show details`)
  })
  .version('0.1.0')
  .command('create <name>')
  .description('create a new project')
  .option('-f, --force', 'overwrite target directory if it exist')
  .action((name, options) => {
    log.outLOGO()
    //åœ¨è¿™ä¸ª../lib/createä¸­è·å–å¯¹åº”çš„è¾“å…¥çš„ä¿¡æ¯ï¼Œé¡¹ç›®åå’Œé€‰é¡¹ï¼Œåé¢æˆ‘ä»¬æ ¹æ®è¿™ä¸ªé€‰é¡¹ç”Ÿæˆ
    require('../lib/create.js')(name, options)
  })


program
  // é…ç½®ç‰ˆæœ¬å·ä¿¡æ¯
  .version(`v${require('../package.json').version}`)
  .usage('<command> [option]')

program.parse(process.argv)  // è§£æå‘½ä»¤

```

### å¯¹ç»ˆç«¯çš„æ–‡æœ¬æ ·å¼å°è£…ä¸‹å§

```
//.lib/log.js  æ ·å¼çš„å°è£…ï¼Œlogoï¼Œchalk
const figlet = require('figlet');
const chalk = require('chalk')

const outLOGO = () => {
  console.log('\r\n' + figlet.textSync('WEB-CORE-CLI', {
    font: 'Standard',
    horizontalLayout: 'fitted',
    width: 120,
    whitespaceBreak: true
  }));
}

const outCyanLog = (info) => {
  console.log(`\n ${chalk.cyan.bold(info)} \n`);
}

const outRedLog = (info) => {
  console.log(`\n ${chalk.red.bold(info)} \n`);
}

module.exports = {
  outLOGO,
  outCyanLog,
  outRedLog
}
```

### æ ¹æ®ç”¨æˆ·äº¤äº’ç”Ÿæˆæ¨¡æ¿

![QQæˆªå›¾20220717165109.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03e095de0ba746b4898f3b2dd5cdd805~tplv-k3u1fbpfcp-watermark.image?)

![QQæˆªå›¾20220717165640.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a26d285170842eb9200a61cd8ee6e66~tplv-k3u1fbpfcp-watermark.image?)

```
/**
 * @description cli
*/
const path = require('path')
const fs = require('fs-extra')
const inquirer = require('inquirer')
const ejs = require('ejs')
const spawn = require('cross-spawn');
const ora = require('ora')
const process = require('process')
const shell = require('shelljs');
const log = require('./log');

let tplList = ['h5', 'node-mock', 'vue3-ts', 'h5-vue2']  //å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶å
let excludeFileList = ['node_modules', 'dist']  //éœ€è¦æ’é™¤çš„æ–‡ä»¶
let noNpmList = ['h5', 'node-mock']  //ä¸éœ€è¦å®‰è£…çš„ä¾èµ–

module.exports = async function (name, options) {
  const cwd = process.cwd() //node å‘½ä»¤æ‰§è¡Œè·¯å¾„ 
  const projUrl = path.join(cwd, name)
  //ç›®å½•ä¸‹å­˜åœ¨æ­¤é¡¹ç›®æ–‡ä»¶å¤¹
  if (fs.existsSync(projUrl)) {
    //æ˜¯å¦å¸¦æœ‰-få¼ºåˆ¶åˆ›å»ºæŒ‡ä»¤
    if (options.force) {
      await fs.remove(projUrl)
    } else {
      //todo: è¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®å®šè¦è¦†ç›–
      inquirer.prompt([
        {
          name: 'action',   //boolean
          type: 'list',
          message: 'Target directory already exists Pick an action:',
          choices: [
            {
              name: 'Overwrite',
              value: 'overwrite'
            }, {
              name: 'Cancel',
              value: false
            }
          ]
        }
      ]).then(async answer => {
        let { action } = answer
        if (!action) {
          return;
        } else if (action === 'overwrite') {
          // ç§»é™¤å·²å­˜åœ¨çš„ç›®å½•
          await fs.remove(projUrl)
          createProject(name, projUrl)
        }
      })
    }
  } else {
    createProject(name, projUrl)
  }
}

/**
 * åˆ›å»ºé¡¹ç›®æ–‡ä»¶
 *
 * @param {string} name
 * @param {string} projUrl
 */
const createProject = (name, projUrl) => {
  let choices = []
  tplList.forEach(item => {
    choices.push({ name: item })
  })
  //è¯¢é—®éœ€è¦çš„æ¨¡æ¿
  inquirer.prompt([
    {
      name: 'tplname',
      type: 'list',
      message: 'è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿ä½¿ç”¨: ',
      choices: choices
    }
  ]).then(async answer => {
    let { tplname } = answer
    if (tplname) {
      const destUrl = path.join(__dirname, '../', 'templates/', tplname);

      deepCopyFiles(destUrl, projUrl, name)  //å¤åˆ¶æ–‡ä»¶

      log.outCyanLog(`ç›®å½•ï¼š ${projUrl} é¡¹ç›®åï¼š${name} åˆ›å»ºæˆåŠŸï¼`)

      startShell(name, tplname)  //å®‰è£…ä¾èµ–
    }
  })
}

/**
 *æ‹·è´æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶
 *
 * @param {string} destUrl
 * @param {string} projUrl
 * @param {string} name
 */
const deepCopyFiles = (destUrl, projUrl, name) => {
  fs.mkdir(projUrl, { recursive: true }, (err) => {
    if (err) return

    fs.readdir(destUrl, (err, files) => {
      if (err) throw err;
      files.forEach((file) => {
        //åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶å¤¹ï¼Œæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        if (!(excludeFileList.findIndex((f) => f === file) > -1)) {
          fs.stat(path.join(destUrl, file), (err, stats) => {
            if (err) return
            if (stats.isDirectory()) {
              deepCopyFiles(path.join(destUrl, file), path.join(projUrl, file), name)
            } else {
              // ä½¿ç”¨ ejs æ¸²æŸ“å¯¹åº”çš„æ¨¡ç‰ˆæ–‡ä»¶
              ejs.renderFile(path.join(destUrl, file), name).then(data => {
                // ç”Ÿæˆ ejs å¤„ç†åçš„æ¨¡ç‰ˆæ–‡ä»¶
                fs.writeFileSync(path.join(projUrl, file), data)
              })
            }
          })
        }
      })
    })
  })
}

/**
 * shellå‘½ä»¤
 */
const startShell = async (name, tplname) => {
  //å¦‚æœæ˜¯ä¸éœ€è¦å®‰è£ä¾è³´çš„
  if (noNpmList.findIndex((item) => item === tplname) > -1) {
    log.outCyanLog(`åˆ›å»º${tplname}æˆåŠŸï¼`)
    return
  }
  const spinner = ora('å®‰è£…ä¾èµ–ä¸­......').start();

  shell.cd(name);

  // å®‰è£…ä¾èµ–
  const pnpmCommend = spawn('pnpm install', [], {
    stdio: 'inherit'
  });

  // ç›‘å¬æ‰§è¡Œç»“æœ
  pnpmCommend.on('close', function (code) {
    // æ‰§è¡Œå¤±è´¥
    if (code !== 0) {
      log.outRedLog('å®‰è£…ä¾èµ–å¤±è´¥')
      process.exit(1);
    }
    // æ‰§è¡ŒæˆåŠŸ
    else {
      log.outCyanLog(`å®‰è£…ä¾èµ–æˆåŠŸï¼ï¼\n cd ${name} \n npm run dev`)
    }
    spinner.stop()
  })
}
```
### å†™å…¥æ¨¡æ¿

åœ¨tempaltesæ–‡ä»¶ä¸­å®šä¹‰ä¸åŒçš„æ¨¡æ¿ï¼Œä¸»è¦æ–‡ä»¶åè¦å¯¹åº”ä¸Šé¢çš„tplListå­—æ®µï¼Œæ ¹æ®éœ€æ±‚å®šä¹‰


![QQæˆªå›¾20220717164359.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a10f484b0b44f31b3c55fc720f639ce~tplv-k3u1fbpfcp-watermark.image?)


### è°ƒè¯•çœ‹ä¸‹ï¼å‘ä¸ªåŒ…



è°ƒè¯•é¦–å…ˆè¦ä¿®æ”¹packageå†…çš„binï¼ˆå…¨å±€åŒ…å‘½ä»¤çš„å…¥å£ï¼‰ã€fileï¼ˆéœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ï¼‰ã€mianå­—æ®µ ï¼ˆé¡¹ç›®æ‰§è¡Œä¸»å…¥å£ï¼‰, åœ¨è°ƒè¯•çš„æ—¶å€™å…¶ä»–æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨npm linkç›´æ¥è½¯è¿æ¥åˆ°nodeçš„npmæ–‡ä»¶å¤¹ä¸­ã€‚é€šè¿‡ npm config get prefix å¿«é€Ÿè·å–æ–‡ä»¶å¤¹è·¯å¾„ã€‚åŒæ—¶ä¹Ÿå¯ä»¥çœ‹ä¸‹fileæ˜¯å¦æˆåŠŸè¿‡æ»¤äº†æ–‡ä»¶ã€‚å¦‚æœæƒ³åœ¨å…¶ä»–åŒ…ä¸­æµ‹è¯•ä½¿ç”¨ï¼Œå»ºè®®æ‰§è¡Œnpx link <ä½ çš„è·¯å¾„>ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å–æ¶ˆé“¾æ¥npm unlink <ä½ çš„è·¯å¾„>ã€‚

å¦‚æœè°ƒè¯•æ²¡é—®é¢˜ï¼Œæˆ‘ä»¬è¦ç¡®ä¿nameå­—æ®µæ˜¯å”¯ä¸€ï¼Œç‰ˆæœ¬é€’å¢ï¼Œç„¶ånrmåˆ‡æ¢npmå®˜æ–¹æºï¼Œç™»å½•ånpm publishå°±å¤§åŠŸå‘Šæˆ ï¼
```
//package.json
{
  "name": "web-core-cli",
  "version": "1.0.3",
  "description": "All-in-one scaffolding, cli integrated with Vue3 ecological chain, cli of H5 page, mock template cli of Node",
  "main": "./bin/cli.js",
  "bin": {
    "web-core-cli": "bin/cli.js"
  },
  "keywords": [
    "cli",
    "allin",
    "vue",
    "template",
    "h5",
    "node"
  ],
  "scripts": {
    "cli": "node ./bin/cli.js"
  },
  "author": "chen",
  "license": "ISC",
  "dependencies": {
    "chalk": "^4.1.2",
    "commander": "^9.3.0",
    "cross-spawn": "^7.0.3",
    "ejs": "^3.1.8",
    "figlet": "^1.5.2",
    "fs-extra": "^10.1.0",
    "inquirer": "^7.3.3",
    "ora": "^5.4.1",
    "shelljs": "^0.8.5"
  },
}
```

### å¦‚ä½•éƒ¨ç½²åˆ°ç§äººä»“åº“ ï¼Ÿ


![mmexport1658048658754.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9b0a433186f4435b7356a980f29fc5b~tplv-k3u1fbpfcp-watermark.image?)

ğŸ˜… æˆ‘ä»¬åšä¸ªç»™å…¬å¸çš„å‰ç«¯åŸºå»ºç”¨çš„å¯ä¸èƒ½ç›´æ¥å‘å¸ƒåˆ°npmå®˜ç½‘ï¼Œé‚£ä¹ˆå…¶å®æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŒ… Verdaccio, é…åˆdockerå®‰è£…ä¸‹ï¼Œç„¶åæ³¨æ„åœ¨`config.yaml`å†™å…¥é…ç½®ï¼Œæ³¨æ„ä¸‹è·¯å¾„ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„ç”¨æˆ·åå’Œè´¦å·ï¼Œä»–ä¹Ÿå¯ä»¥ç»Ÿä¸€ç®¡ç†é‚£ä½ çš„è´¦å·æ•°æ®åœ¨æŸä¸ªæ–‡ä»¶ä¸­ã€‚é‚£ä¹ˆåé¢æ— énrm add ä½ çš„ipåœ°å€ï¼Œç„¶ånpm publish, é‚£ä¹ˆä½ çš„ç§æœ‰ä»“åº“å°±æ­å»ºä¸Šå»äº†ï¼Œä¸æ˜ç™½çš„å°ä¼™ä¼´å¯ä»¥ç½‘ä¸Šçœ‹çœ‹æ•™ç¨‹ã€‚

### è¿˜æœ‰å“ªäº›ä¼˜åŒ–çš„ç‚¹ï¼Ÿ

1.å…¶å®å¯ä»¥è·Ÿvueä¸€æ ·æœ‰ä¸ªé»˜è®¤é…ç½®å’Œè‡ªå®šä¹‰é…ç½®çš„ï¼Œå½“ç„¶ç›®å‰è¿™ä¸ªè¿˜æ˜¯ä¸ªé›å½¢ï¼Œé€šè¿‡ejsæ¨¡æ¿çš„å˜é‡å¯ä»¥æ§åˆ¶å¾ˆå¤šä¸œè¥¿ï¼Œè¿™é‡Œå¯ä»¥å¤šæŒ–ä¸€äº›ä¸œè¥¿ã€‚


![logo (3).png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c2ce5f7dd534ac28b41d7dedb2d486a~tplv-k3u1fbpfcp-watermark.image?)
